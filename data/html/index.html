<!DOCTYPE html>
<html>

<head>
    <script>
        window.resizeTo(800, 1000)
    </script>
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/materialize.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/items.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8">
    <title>Graveyard Keeper Savefile Editor | Edit Savefile</title>
</head>

<body>
    <header></header>
    <main>
        <div class="con">
            <div class="loadingconwrap">
                <div class="loadingcon">
                    <div class="row">
                        <div>Loading the save file</div>
                    </div>
                    <div class="row">
                        <div class="progress">
                            <div class="indeterminate"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    <div class="loadingmask valign-wrapper" style="display: none;">
        <div class="loading">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer></footer>
    <script>

        let disable_context_menu = true;

        const strangersins_item_range = [820, 888]
        const gameofcrone_item_range = [889, 1002]
        const bettersavesoul_item_range = [1003, 1052]

        const displayed_infos_dlc = {
            "gameofcrone": false,
            "strangersins": false,
            "bettersavesoul": false,
        }

        // Contextmenu is not needed, for that reason it is disabled
        $(document).contextmenu(function(e){
            if (disable_context_menu) {
                e.preventDefault()
            }
        });

        // Allow context menu when ALT was clicked once
        $("body").keydown(function(e){
            if(e.altKey == true){
                disable_context_menu = false;
            };
        })

        // Setup global variables
        let gamedata = {}
        let autocompletenames = {}
        let data = {};
        let error = false;
        let imageurls = {};

        // Load the data depending on the save file type
        async function getSaveFile(info) {
            if (info[0] === "slot") {
                data = await eel.get_savefile(info[2], info[1])();
            } else if (info[0] === "importjson") {
                data = await eel.get_json_savefile(info[1])();
            } else if (info[0] === "importdat") {
                data = await eel.get_custom_savefile(info[1])();
            }

            // Display an error, should there be one
            if (data.hasOwnProperty("Error")) {
                $(".con").html(`<div class="intro error"><h3>The following error occured: ` + data["Error"] +
                    `</h3></div>`)
            } else {
                console.log(data)


                // When closing the save file editor, free memory
                window.addEventListener("beforeunload", function (e) {
                    eel.unload_save(window.location.hash.split("#")[1].split("|")[1]);
                });

                // Load the data about items, so we know which ids are items, which are perks and so on
                fetch('/items.json')
                    .then(function (response) {
                        return response.json();
                    })
                    .then(async function (json) {
                        gamedata = json;
                        // Generate the dictionaries used for the autocomplete
                        gamedata.items.forEach((item, i) => {
                            // Don't include stranger sins items
                            if (i >= strangersins_item_range[0] && i <= strangersins_item_range[1] && !settings["strangersins"]){
                                return
                            }
                            // Don't include game of crone items
                            if (i >= gameofcrone_item_range[0] && i <= gameofcrone_item_range[1] && !settings["gameofcrone"]){
                                return
                            }
                            // Don't include better save soul items
                            if (i >= bettersavesoul_item_range[0] && i <= bettersavesoul_item_range[1] && !settings["bettersavesoul"]){
                                return
                            }
                            autocompletenames[(data["locals"][item] || data["locals"][item.replace(/:\d$/g, "")]) + " (" + item + ")"] = null
                        })


                        await applyData()
                        generateEvents()
                    })

            }


        }

        // Create the HTML structure with the data we now have
        async function applyData() {
            // The base HTML of the form (values which you can edit directly and are not in a list)
            d =
                `
<div class="intro lesspadding">Generic:</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="row colorpoints">
            <div class="input-field col s4">
                <div class="gameicon i-red pre">
                    <img src="/rsc/Red_Tech_Symbol.png">
                </div>
                <input id="red" value="${data["r"]["cur"]}">
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-green pre">
                    <img src="/rsc/Green_Tech_Symbol.png">
                </div>
                <input id="green" value="${data["g"]["cur"]}">
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-blue pre">
                    <img src="/rsc/Blue_Tech_Symbol.png">
                </div>
                <input id="blue" value="${data["b"]["cur"]}">
            </div>
        </div>
        <div class="row money">
            <div class="input-field col s4">
                <div class="gameicon i-gold pre">
                    <img src="/rsc/Gold_Coin_Symbol.png">
                </div>
                <input id="gold" min="0" type="number" class="validate valid" value="${Math.floor(data["money"] / 100 << 0)}">
                <span class="helper-text" data-error="Please input a number greater than 0" data-success="">Please input a number greater than 0</span>
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-silver pre">
                    <img src="/rsc/Silver_Coin_Symbol.png">
                </div>
                <input id="silver" max="99" min="0" type="number" class="validate valid" value="${Math.floor(data["money"] % 100)}">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-copper pre">
                    <img src="/rsc/Copper_Coin_Symbol.png">
                </div>
                <input id="copper" max="99" min="0" type="number" class="validate valid" value="${Math.round(data["money"]%1*100)}">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
        </div>
        <div class="row hpenergy">
            <div class="col s12">
                HP:
                <div class="input-field inline s8">
                    <input id="hp" type="number" class="validate valid" min="0" value="${data["hp"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>


            <div class="col s12 energy">Energy:
                <div class="input-field inline s8">
                    <input id="energy" type="number" class="validate valid" min="0" value="${data["energy"]["cur"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        </div>

        <div class="timecontainer">
            <div class="note hover"><b>WARNING:</b><br>Modify the time at your own risk. Don't forget NPC's walk to all events
            and they get triggered at certain positions at certain times - meaning if you change the time you can mess up their
            AI.<br>If you want to meet the merchant f.e. - set the day to Gluttony (the 3rd one) and change the Time to f.e.
            3:00 - this is because the change from morning to day leaves the merchant enough time to walk to the barn and also
            triggers his change of location in the morning. - if you would set it f.e. to 12:00 he wouldn't appear</div>
            <div class="col s12 energy">Current Day:
                <div class="input-field inline s8">
                    <input id="day" type="number" class="validate valid" min="0" value="${data["time"]["day"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        <div class="dayindicator col s12">
            <div class="day active"><img src="/rsc/pride.png"></div>
            <div class="day"><img src="/rsc/lust.png"></div>
            <div class="day"><img src="/rsc/gluttony.png"></div>
            <div class="day"><img src="/rsc/envy.png"></div>
            <div class="day"><img src="/rsc/wrath.png"></div>
            <div class="day"><img src="/rsc/sloth.png"></div>
        </div>
        <div class="timeofdayslider col s12">
            <p class="range-field">
                <input type="range" id="timeofday" min="0" max="24" step="0.25" />
            </p>
            <p class="timeoutput">24:00</p>
        </div>

        </div>

        <div class="row miscbuttons">
            <div class="btn deldrops col s6 offset-s3">Remove all Drops</div>
            <div class="btn workereff col s12">Set all workers to 40% Efficiency</div>
            <div class="note hover col s12"><b>WARNING:</b><br>For the perfect bodies/workers/graves to work it is necessary to have the technologies / crafting recipes like embalming because otherwise the game "resets" those bodies / decorations to a state which you could have done with your current tech tree / advancement. For this reason a "Unlock the entire tech tree" button was added. <b>BUT</b> the game save is rather complex, meaning even if you have all technologies and theoretically you couldn't have advanced this far the bodies will be bugged, f.e. broken in the morgue table. I assume (without having looked at the game code) that you need a certain progress in the game. F.e. when I used all technologies + perfect bodies on a completely new save, the bodies had 7 skulls, but actually (when taking a look at the exported save) the bodies where the correct bodies. So progress normally and use the unlock tech tree button or perfect worker button on a late game save (or where you already manually could produce the perfect bodies, but are lacking the resources)</div>
            <div class="btn perbody col s12">Replace all the bodies in graves with perfect bodies</div>
            <div class="btn perdeco col s12">Set all grave decorations to the highest</div>
            <div class="btn perempty col s12">Replace all empty graves with perfect graves</div>
            <div class="btn pertech col s12">Unlock the entire tech tree</div>
            <div class="note col s12"><b>Note:</b><br>This is pre version 1.200</div>
            <div class="btn repairdonkey col s12">Replace your current donkey NPC</div>
            <div class="note hover col s12"><b>WARNING:</b><br>This replaces your current donkey object with the a working one from my savefile. It will then be in front of your morgue. <b>Don't be surprised if it doesn't drop the body even if you have enough carrots. Through replacing the donkey this check gets skipped.</b> Just put 10 more in and the donkey should work - I tried it on a save in the bug report channel of the discord (from Lazy Bear Games). ONLY USE THIS IF THE BUG FIX OF THE DEVELOPERS DIDN'T WORK AND YOU ALREADY HAVE THE BOX WITH CARROTS. <b>Also only use this if your donkey is actually stuck!</b></div>
            <div class="btn resetmorgue col s12">Reset Morgue Counter</div>
            <div class="note hover col s12"><b>Note:</b><br>This will set your current morgue spaces used to 0, meaning if it got bugged at some point you will have at least 1 delivery. (Although I do not know how this value gets set again, like if it is only increased by one or the entire morgue is checked for bodies)</div>
            <div class="btn removechurchvisitors col s12">Delete Church Visitor NPCs</div>
            <div class="note hover col s12"><b>Note:</b><br>Sometimes the church visitors just stay in your church as if it is their home. Use this button to evict them. (This deletes all npc_church_visitor entities.)</div>
            <div class="btn resetdungeon col s12">Reset the dungeon</div>
        </div>
    </form>
</div>
<div class="intro lesspadding">Inventory:
<br>
<div class="note hover"><b>Note:</b><br> Only use qualities on items which have them and don't set no quality on items which have qualities, otherwise that will cause issues within the game. <br><b>Adding items works for normal items, but some items require special meta data and the editor needs edge cases for them, this includes for example bags, bag_universal and bag_univeral_big work, but other bags probably won't, this source data needs to be manually added to the editor and requires a save which contains a working version of the item if you want me to add it to the editor.</b></div>
</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="row">
            <div class="col s12">Inventory size:
                <div class="input-field inline s8">
                    <input id="invsize" type="number" class="validate valid invsize" min="0" value="${data["inventory_size"]["cur"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        </div>
        <div class="items">
        </div>
        <p>Add Item:</p>
        <div class="item add">
            <div class="itemimage">
                <div class="itemquality"></div>
                <div class="item_icon"></div>
            </div>
            <div class="iteminfo">
                <div class="itemname autocomplete">
                    <div class="input-field col s12">
                        <input type="text" class="autocomplete itemn">
                    </div>
                </div>
                <div class="itemmisc">
                    <div class="amount">
                        <div>Amount:</div>
                        <input type="number" value="1">
                    </div>
                    <div class="btncon">
                        <div class="btn repairbtn">Add</div>
                    </div>
                </div>
            </div>
        </div>
        <p>Equipped Items:</p>
<div class="note hover"><b>WARNING:</b><br>Change the item to a non tool item at your own risk.</div>
        <div class="equipped-items">
        </div>
    </form>
</div>
<div class="intro lesspadding">Additional Storages</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="additionalitems">
        </div>
    </form>
</div>
<div class="intro lesspadding">Relationships:
    <br>
    <div class="note">[Note: This may not work in some cases, because it does not modify the underlying quest values. I could also assume, that it gets reset after you do a specific quest.]</div>
</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="relationships">
        </div>
    </form>
</div>
<div class="intro lesspadding">Perks:<br><div class="note">[Note: You can only view perks here. You get them through technologies so get yourself the red, green and blue points if you want to add more.]</div></div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="perks">
        </div>
    </form>
</div>
<div class="intro lesspadding">Save or Export:</div>
<div class="row savingcon">
    <div class="col s12"><div class="btn" id="overwrite">Save to save slot (creates a backup)</div></div>
    <div class="col s12"><div class="btn" id="exportjson">Export to a .json file</div></div>
    <div class="col s12"><div class="btn" id="exportdat">Export to a .dat file</div></div>
</div>`
            // Replace the loading bar with our currently loaded data
            $(".con").html(d)

            // Hide the remove drops button of there are none
            if (data["drops"].length == 0) $(".deldrops").hide();

            // Show a loader because no events are applied to the buttons yet so the user knows he still has to wait
            $(".loadingmask").fadeIn(500);

            $("#timeofday").val((data.time.timeofday + 1) * 12);


            // When changing the time of the day, change the value in the save
            $('#timeofday').on("input", function () {

                let t = parseFloat($("#timeofday").val());
                // Display new time
                $(".timeoutput").text(Math.floor(t) + ":" + Math.floor(t % 1 * 60));
                if($(".timeoutput").text().split(":")[1].length == 1) $(".timeoutput").text($(".timeoutput").text()+"0")

                data.time.timeofday = (t / 12)-1;
            });
            $("#timeofday").trigger("input")

            // When changing the day, change the active image and the data
            $("#day").on("input", function(){
                $(".day").removeClass("active");
                $($(".day")[(parseInt($("#day").val())-1) % 6]).addClass("active");
                data["time"]["day"] = parseInt($("#day").val());
            })

            // Set the correct image to active once
            $("#day").trigger("input");

            // Enable clicking on a day of the week to set the day in the current week
            $(".day").click( e => {
                // Get the current day in the range of 1-6 (if % 6 produces 0, the || 6 will cause the value 6 to be returned)
                let cur = parseInt($("#day").val()) % 6 || 6;
                // Get the correct offset of the day in the current week
                let difference = $(e.currentTarget).index()+1 - cur;
                // Set the value in the form field
                $("#day").val(parseInt($("#day").val()) + difference);
                // Update the other values
                $("#day").trigger("input");
            })

            // Add the items in the inventory to the form
            for (let i = 0; i < data["inventory"].length; i++) {
                addItem(data["inventory"][i], $(".items"));
            }

            // Add the items in tool section to the equipped inventory list (only allow repairs)
            for (let i = 0; i < data["subinventory"].length; i++) {
                addItem(data["subinventory"][i], $(".equipped-items"));
            }

            // Add additional inventories
            for (let i = 0; i < data["additionalstorage"].length; i++) {
                await addInventory(data["additionalstorage"][i], i);
            }

            // Add relationships
            for (let i = 0; i < data["relationships"].length; i++) {
                await addRelationShip(data["relationships"][i]["v"].replace("_rel_", ""), data["relationships"][i][
                    "cur"
                ]);
            }

            // Add the current perks to the form
            for (let i = 0; i < data["perks"].length; i++) {
                await addPerk(data["perks"][i]["v"]);
            }


        }

        // For a specific inventory generate the preview images by copying every item icon and putting it as small version in a different container
        function createInventoryMiniPreview(index) {
            let element = $($("#inv" + index).parent().find(".inventoryminipreview")[0])
            element.html("");
            $("#inv" + index).parent().find(".items .item_icon").clone().appendTo(element);
        }

        // Add an additional storage to the list
        async function addInventory(inventory, index) {

            // The names of the possible id's
            let types = {
                "mf_box_stuff": "(Trunk)",
                "chest": "(Chest)",
                "rack_alchemy": "(Alchemy Rack)",
                "obj_church_scroll_cabinet": "(Scrollshelf)",
                "obj_church_bookcase": "(Bookshelf)",
                "rack_organs": "(Mortuary rack)",
            }
            let type = "";
            // If we have a name for it, we add it
            if (types.hasOwnProperty(inventory["type"])) type = types[inventory["type"]];
            // The base HTML for a single additional Inventory
            let inv =
                `
<div class="inventorycon">
<div class="invtinfo" id="inv${index}">Storage ${index+1} <div class="itemid">${type}</div></div>
<div class="inventoryminipreview"></div>
<div class="invt">
<!--After trying it seems inventory size for the storage units is hard coded, thats why we hide it--!>
<div class="row hide">
    <div class="col s12">Inventory size:
        <div class="input-field inline s8">
            <input type="number" class="validate valid invsize" min="0" value="${inventory["size"]}">
            <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
        </div>
    </div>
</div>
<div class="items">
</div>
<p>Add Item:</p>
<div class="item add">
    <div class="itemimage">
        <div class="itemquality"></div>
        <div class="item_icon"></div>
    </div>
    <div class="iteminfo">
        <div class="itemname autocomplete">
            <div class="input-field col s12">
                <input type="text" class="autocomplete itemn">
            </div>
        </div>
        <div class="itemmisc">
            <div class="amount">
                <div>Amount:</div>
                <input type="number" value="1">
            </div>
            <div class="btncon">
                <div class="btn repairbtn">Add</div>
            </div>
        </div>
    </div>
</div>
</div>
</div>`
            // Append this HTML to our container for additional storage inventories
            $(".additionalitems").append(inv);

            // Add every item to the inventory
            for (let i = 0; i < inventory["items"].length; i++) {
                addItem(inventory["items"][i], $("#inv" + index).parent().find(".items"));
            }
            
            // Create a preview for that inventory (so it uses less page space)
            createInventoryMiniPreview(index);
        }

        // Turn a specific ID into a name
        // Here we have additional checks for item qualities
        function getLocalisation(id) {

            // Check the index of the id where we fetch the localisation within the item array to do a DLC check
            let index = gamedata.items.indexOf(id);

            // If the save contains items of a disabled DLC show a notification
            if(index >= gameofcrone_item_range[0] && index <= gameofcrone_item_range[1] && !settings["gameofcrone"]){
                if(!displayed_infos_dlc["gameofcrone"]){
                    displayed_infos_dlc["gameofcrone"] = true;

                    // Display an info considering the DLC
                    let m = M.toast({html: `<div><p>It seems like the save contains items from the Game of Crone DLC but you didn't enable it in the settings.</div><div class="confirm">Click here to enable Game of Crone support</div>`, displayLength: 60000})
                    $(m.el).find(".confirm").click(async function() {
                        m.dismiss();

                        // Save the settings
                        settings["gameofcrone"] = true;
                        await eel.set_settings(settings)();

                        // Add the autocomplete names
                        for(let i = gameofcrone_item_range[0]; i < gameofcrone_item_range[1]; i++) {
                            autocompletenames[(data["locals"][gamedata.items[i]] || data["locals"][gamedata.items[i].replace(/:\d$/g, "")]) + " (" + gamedata.items[i] + ")"] = null
                        }
                    })
                }
            }
            if(index >= strangersins_item_range[0] && index <= strangersins_item_range[1] && !settings["strangersins"]){
                if(!displayed_infos_dlc["strangersins"]){
                    displayed_infos_dlc["strangersins"] = true;

                    // Display an info considering the DLC
                    let m = M.toast({html: `<div><p>It seems like the save contains items from the Stranger Sins DLC but you didn't enable it in the settings.</div><div class="confirm">Click here to enable Stranger Sins support</div>`, displayLength: 60000})
                    $(m.el).find(".confirm").click(async function() {
                        m.dismiss();

                        // Save the settings
                        settings["strangersins"] = true;
                        await eel.set_settings(settings)();

                        // Add the autocomplete names
                        for(let i = strangersins_item_range[0]; i < strangersins_item_range[1]; i++) {
                            autocompletenames[(data["locals"][gamedata.items[i]] || data["locals"][gamedata.items[i].replace(/:\d$/g, "")]) + " (" + gamedata.items[i] + ")"] = null
                        }
                    })
                }
            }

            if(index >= bettersavesoul_item_range[0] && index <= bettersavesoul_item_range[1] && !settings["bettersavesoul"]){
                if(!displayed_infos_dlc["bettersavesoul"]){
                    displayed_infos_dlc["bettersavesoul"] = true;

                    // Display an info considering the DLC
                    let m = M.toast({html: `<div><p>It seems like the save contains items from the Better Save Soul DLC but you didn't enable it in the settings.</div><div class="confirm">Click here to enable Better Save Soul support</div>`, displayLength: 60000})
                    $(m.el).find(".confirm").click(async function() {
                        m.dismiss();

                        // Save the settings
                        settings["bettersavesoul"] = true;
                        await eel.set_settings(settings)();

                        // Add the autocomplete names
                        for(let i = bettersavesoul_item_range[0]; i < bettersavesoul_item_range[1]; i++) {
                            autocompletenames[(data["locals"][gamedata.items[i]] || data["locals"][gamedata.items[i].replace(/:\d$/g, "")]) + " (" + gamedata.items[i] + ")"] = null
                        }
                    })
                }
            }

            if (data["locals"].hasOwnProperty(id)) {
                return data["locals"][id];
            } else if (/:\d$/.test(id)) {
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ""))) return data["locals"][id.replace(/:\d$/, "")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":1"))) return data["locals"][id.replace(/:\d$/,
                    ":1")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":2"))) return data["locals"][id.replace(/:\d$/,
                    ":2")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":3"))) return data["locals"][id.replace(/:\d$/,
                    ":3")];
            } else {
                if (data["locals"].hasOwnProperty(id + ":1")) return data["locals"][id + ":1"];
                if (data["locals"].hasOwnProperty(id + ":2")) return data["locals"][id + ":2"];
                if (data["locals"].hasOwnProperty(id + ":3")) return data["locals"][id + ":3"];
            }
            return undefined;
        }


        // Turn an item id into the correct id for the css classes for the icons
        function sanitzize_item_id(id){
            // CSS doesn't allow leading numbers
            if(id.match(/^\d/)){
                id = "_" + id
            };
            id = id.replace(/(:1|:2|:3)$/, "").replace(/:/g, "__")
            if (!id.startsWith("embalm")) id = id.replace(/_-?\d_-?\d/, "")
            return id
        }

        // Get the URL to the item icon by id
        async function getItemUrl(id) {

            if(imageurls.hasOwnProperty(id)){
                return imageurls[id];
            }

            // File names can't contain ":" thats why the files have "__" instead of ":" 
            let url = "/rsc/" + id.replace(/:/g, "__") + ".png"
            let t = await fetch(url)
            if (t.status == 404) {
                // If the file does not exist first check if it an item with a quality and then replace the quality with nothing
                if (/:\d$/.test(id)) {
                    let t2 = await fetch(url.replace(/__\d/, ""))
                    //If the file still doesn't exist use the unknown placeholder as icon
                    if (t2.status == 404) {
                        url = "/rsc/unknown_item.png"
                    } else {
                        url = url.replace(/__\d/, "");
                        imageurls[id] = url;
                    }
                } 
                // Check if the file is an organ and then try again with the base name
                else if (/_-?\d_-?\d/.test(id)) {
                    let t2 = await fetch(url.replace(/_-?\d_-?\d/, ""))
                    //If the file still doesn't exist use the unknown placeholder as icon
                    if (t2.status == 404) {
                        url = "/rsc/unknown_item.png"
                    } else {
                        url = url.replace(/_-?\d_-?\d/, "");
                        imageurls[id] = url;
                    }
                } else {
                    url = "/rsc/unknown_item.png"
                }
            }
            imageurls[id] = url;
            return url;
        }

        //Function to add a single item
        async function addItem({id, amount, durability, subinventory = [], position = -1}, element) {

            //Check for a quality of the item
            let quality = "";
            if(["1","2","3"].includes(id.split(":").pop())){
                quality = [" copper", " silver", " gold"][parseInt(id.split(":").pop())-1]
            }

            //If the item can be repaired, add a button to do that
            let button = ""
            if (durability !== 1) {
                button = '<div class="btn repairbtn">Repair (' + Math.round(durability * 100) + '% left)</div>'
            }
            //HTML of a single item
            let item =
                `
<div class="item justadded${quality}" data-position="${position}">
    <div class="itemimage">
        <div class="itemquality"></div>
        <div class="item_icon ${sanitzize_item_id(id)}"></div>
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)} <div class="itemid">(${id})</div></div>
        <div class="itemmisc">
            <div class="amount">
                <div>Amount:</div>
                <input type="number" value="${amount}">
            </div>
            <div class="btncon">
                ${button}
            </div>
        </div>
    </div>
    <div class="valign-wrapper">
        <div class="itemremove">x</div>
    </div>
    <div class="inventoryminipreview">${subinventory.map(item => `<div class="item_icon ${sanitzize_item_id(item["id"])}"></div>`).join("")}</div>
</div>`
            
            //Get the Element which we create
            let el = $(item).appendTo(element)
            

            //Check if the Inventory Preview needs to be updated
            if ($(el).parents(".inventorycon").length > 0) {
                createInventoryMiniPreview(parseInt($(el).parents(".inventorycon").find(".invtinfo").attr("id").split("inv")[1]));
            }
            
            return true;
        }

        //Function to add a single Perk to the list
        async function addPerk(id) {
            //If our localisation has it, add a description to the perk
            let description = (data["locals"].hasOwnProperty(id + "_d")) ? data["locals"][id + "_d"] : "";
            //HTML of a single perk
            let item =
                `
<div class="item justadded">
    <div class="itemimage">
        <img src="">
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)} <div class="itemid">(${id})</div></div>
        <div class="itemmisc">
            <div class="amount">
                <div>${description}</div>
            </div>
        </div>
    </div>
</div>`
            // Get the element we create
            let el =  $(item).appendTo(".perks")
            //Check if we have a icon for the id, if not use default icon
            //Then change the item image, when it is loaded
            getItemUrl(id).then((url) => {
                el.find(".itemimage img").attr("src", url);
            });
        }

        // Function to add a single Relationship to the list
        // Amount is the current friendliness
        async function addRelationShip(id, amount) {


            // HTML for a single Relationship
            let relationship =
                `
<div class="item justadded">
    <div class="npcimage">
        <img src="">
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)}
            <div class="itemid">(${id})</div>
        </div>
        <div class="itemmisc">
            <div class="amount">
                <div class="gameicon i-friendship">
                    <img src="/rsc/Happiness_or_Friendship_Symbol.png">
                </div>
                <input type="number" class="validate valid" value="${amount}" max="100" min="0">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
        </div>
    </div>
</div>`
            // Add the HTML to the page, get the newly created element
            let el = $(relationship).appendTo(".relationships");

            // Get the URL of the NPC
            getItemUrl(id).then((url) => {
                el.find(".npcimage img").attr("src", url);
            });
        }

        // Bind events to the DOM after (most) content loaded
        function generateEvents() {

            // If we are not loading from a savefile, remove the save to saveslot button
            if (window.location.hash.split("#")[1].split("|").length < 3) {
                $("#overwrite").remove();
            }

            // Setup autocomplete for add item
            $('.add input.autocomplete.itemn').autocomplete({
                data: autocompletenames,
                minLength: 0,
                onAutocomplete: updateAddItemPreview
            });

            // Toggle the additional storage to either have the full view with the capability to edit or to just see the items as small icons
            $(".invtinfo").click(function () {
                $(this).parent().toggleClass("active");
            });

            // Bind functions to the add buttons
            $(".add:not(.perk) .btn.repairbtn").click(addItemButton);


            // Remove an item on click
            $(".items, .equipped-items").on("click", ".itemremove", function () {
                let e = $(this);

                // extract the id
                let id = e.parent().parent().find(".itemid").text().split("");
                id.shift();
                id.pop();
                id = id.join("");

                e.parent().parent().addClass("toremove");
                // Timed functions to have a CSS animation
                setTimeout(() => {
                    let index = e.parent().parent().index();
                    // Update the data in our array, so the relative positions of items stay the same
                    // We have 2 functions depending on if it is in the main inventory or in the inventory of an additional storage
                    // Additional storage
                    if (e.parents(".additionalitems").length > 0) {
                        let invindex = parseInt(
                            $(e).parents(".inventorycon").find(".invtinfo").attr("id").split("inv")[1]
                            )
                        data["additionalstorage"][invindex]["items"].splice(index, 1);
                        // Because items were removed we need to update the mini items preview
                        setTimeout(function () {
                            createInventoryMiniPreview(invindex)
                        }, 100);

                    }
                    //Sub Inventory
                    else if(e.parents(".equipped-items").length > 0) {
                        data["subinventory"].splice(index, 1)
                    }
                    // Own inventory
                    else data["inventory"].splice(index, 1)
                    // Remove the HTML from the DOM
                    e.parent().parent().remove();
                }, 520);
            });

            //Make item quality toggle able by keeping to click the icon
            $(".items, .item.add").on("click", ".itemquality", function () {
                let e = $(this);
                let item = e.parent().parent()

                // extract the id 
                let id;
                // The first in in the case of the field to add an item, because there we don't have an extra div which contains the id
                if (item.hasClass("add")) {
                    id = item.find(".itemname input").val().split("(").pop().split(")")[0];
                } else {
                    id = item.find(".itemid").text().split("");
                    id.shift();
                    id.pop();
                    id = id.join("");
                }

                // create the new id based on the old id (->copper->silver->gold->nothing->)
                let newid;
                if (item.hasClass("copper")) {
                    newid = id.replace(/:\d$/, ":2");
                    item.removeClass("copper");
                    item.addClass("silver");
                } else if (item.hasClass("silver")) {
                    newid = id.replace(/:\d$/, ":3");
                    item.removeClass("silver");
                    item.addClass("gold");
                } else if (item.hasClass("gold")) {
                    newid = id.replace(/:\d$/, "");
                    item.removeClass("gold");
                } else {
                    newid = id + ":1";
                    item.addClass("copper");
                }

                // Change the item id (again depending on if normal item name or if currently a input field)
                if (item.hasClass("add")) {
                    console.log(id)
                    console.log(newid)
                    item.find(".itemname input").val(item.find(".itemname input").val().replace(id, newid));
                } else {
                    item.find(".itemid").text("(" + newid + ")");
                }

                if ( !settings["expert"]){
                    if(!gamedata.items.includes(newid)){
                        item.addClass("unknown_item");
                    } else {
                        item.removeClass("unknown_item");
                    }
                }


            });


            //Handle changing an item
            $(".items, .equipped-items").on("click", ".itemname:not('.curactive')", function () {
                let e = $(this).parent();
                let prevtxt = e.find(".itemname").text();
                $(this).addClass("curactive")
                $(this).html(
                    `
                <div class="input-field col s12 currentlyediting">
                    <input type="text" class="autocomplete itemn">
                </div>
                ` + ((settings["expert"]) ? "Press enter to complete a custom item instead of the auto complete. (Don't forget the () )" : "")
                )
                let x;



                // The function changing the data, when an auto complete is selected
                let d = async function () {
                    try {
                        let val = $(e).find("input").val();
                        console.log(val);
                        if (val.split("(").length > 1) {
                            // Get the item ID and URL
                            let id = val.split("(").pop().split(")")[0];

                            // Destroy the Autocomplete Object
                            M.Autocomplete.getInstance($(e).find(".itemname input")).destroy();

                            // Create new HTML
                            $(e).parent().find(".item_icon").attr("class", "item_icon "+ sanitzize_item_id(id));
                            $(e).find(".itemname").html(getLocalisation(id) + ' <div class="itemid">(' + id +
                                ')</div>');
                            $(e).find(".itemname").removeClass("curactive");

                            let iconholder = $(e).parent()
                            iconholder.removeClass("gold silver copper")
                            iconholder.attr("data-position", -1)
                            iconholder.find(".inventoryminipreview").empty()
                            if(["1","2","3"].includes(id.split(":").pop())){
                                iconholder.addClass(["copper", "silver", "gold"][parseInt(id.split(":").pop())-1])
                            }

                            if ( !settings["expert"]){
                                if(!gamedata.items.includes(id)){
                                    iconholder.addClass("unknown_item");
                                } else {
                                    iconholder.removeClass("unknown_item");
                                }
                            }
                        }
                    }
                    catch(e) {
                        console.log(e);
                    }
            
                };

                if ( settings["expert"]){
                    $(this).find(".autocomplete.itemn").val(prevtxt);
                    $(this).find(".autocomplete.itemn").keyup( e => {
                        if(e.which === 13)
                            d();
                    })
                }


                // The logic for the autocomplete
                $(this).find("input").autocomplete({
                    data: autocompletenames,
                    minLength: 0,
                    onAutocomplete: d
                });
            });

            // Repair logic --> set the durability to 1 on a broken item
            $(".items, .equipped-items").on("click", ".repairbtn", function () {
                let e = $($(this).parents()[3]);
                if (e.parents(".additionalitems").length > 0) {
                    let invindex = parseInt($(this).parents(".inventorycon").find(".invtinfo").attr("id").split(
                        "inv")[1])
                    data["additionalstorage"][invindex]["items"][e.index()]["durability"] = 1;
                } else if(e.parents(".equipped-items").length > 0) {
                    data["subinventory"][e.index()]["durability"] = 1;
                }
                else data["inventory"][e.index()]["durability"] = 1;
                e.find(".repairbtn").remove();

            });

            // Create the side menu with the sections for quicker navigation
            $("main").append('<div class="sidemenu"></div>');

            // Automatically extract the possible sections and the start letter and add the full name on hover
            let sections = $(".intro.lesspadding");
            for (let i = 0; i < sections.length; i++) {
                let s = $(sections[i]);
                let str = s.text().split(":")[0];
                $(".sidemenu").append("<div title=" + str + ">" + str[0].toUpperCase() + "</div>");
            }

            // Bind the event to scroll on click, we have to consider the zoom property, meaning we have to multiply by it, otherwise the offsets are wrong
            $(".sidemenu div").click(function () {
                $("html, body").animate({
                    scrollTop: $($(".intro.lesspadding")[$(this).index()])[0].offsetTop * parseFloat(
                        window.getComputedStyle(document.body).getPropertyValue("zoom"))
                }, 1000);
            })


            // Functions to initiate the saving the clicking the corresponding buttons
            $("#overwrite").click(function () {
                startSaving("slot");
            })

            $("#exportjson").click(function () {
                startSaving("json");
            })

            $("#exportdat").click(function () {
                startSaving("dat");
            })

            // Handle clicking the Delete Drops Button
            $(".deldrops").click(function () {

                // Generate an object with each item and the amount of them
                // But that amount is only item objects - a single item can have f.e. a stack size of 12 already
                let out = {};
                data.drops.map(e => {e = getLocalisation(e) || e;out.hasOwnProperty(e) ? out[e]++ : out[e] = 1});

                // Display a warning
                let m = M.toast({html: `<div><p>Warning - this will remove ${data.drops.length} item(s) / group(s) from your game including:</p> ${Object.keys(out).map(e => {return out[e]+"x " + e}).join(", ")}</div><div class="confirm">Click here to confirm</div>`, displayLength: 1000000})
                $(m.el).find(".confirm").click(function() {
                    m.dismiss();
                    data.drops = [];

                    M.toast({html: "Removed drops successfully"});     

                    // Prevent the dialog to fire again
                    $(".deldrops").addClass("disabled");
                    $(".deldrop").unbind("click");
                })
            })

            // Handle clicking the 40% efficiency button
            $(".workereff").click(function () {
                data.switches.workers = true;
                $(".workereff").addClass("disabled");
                $(".workereff").unbind("click");
            })
            // Handle clicking the replace bodies button
            $(".perbody").click(function () {
                data.switches.gravebodies = true;
                $(".perbody").addClass("disabled");
                $(".perbody").unbind("click");
            })
            // Handle clicking the grave decoration button
            $(".perdeco").click(function () {
                data.switches.decorations = true;
                $(".perdeco").addClass("disabled");
                $(".perdeco").unbind("click");
            })
            // Handle clicking the empty graves button
            $(".perempty").click(function () {
                data.switches.emptygrave = true;
                $(".perempty").addClass("disabled");
                $(".perempty").unbind("click");
            })
            // Handle clicking the perfect tech tree button
            $(".pertech").click(function () {
                data.switches.techtree = true;
                $(".pertech").addClass("disabled");
                $(".pertech").unbind("click");
            })
            // Handle clicking the repair donkey
            $(".repairdonkey").click(function () {
                data.switches.donkey = true;
                $(".repairdonkey").addClass("disabled");
                $(".repairdonkey").unbind("click");
            })
            // Handle clicking the repair donkey
            $(".resetmorgue").click(function () {
                data.switches.resetmorgue = true;
                $(".resetmorgue").addClass("disabled");
                $(".resetmorgue").unbind("click");
            })
            // Handle clicking the remove church visitors button
            $(".removechurchvisitors").click(function () {
                data.switches.removechurchvisitors = true;
                $(".removechurchvisitors").addClass("disabled");
                $(".removechurchvisitors").unbind("click");
            })
            
            // Handle clicking the remove church visitors button
            $(".resetdungeon").click(function () {
                $(".resetdungeon").addClass("disabled");
                $(".resetdungeon").unbind("click");

                let m = M.toast({html: `<div><p>Do you also want to randomise the dungeon?</p></div><div class="confirm yes">Yes</div><div class="confirm no">No</div>`, displayLength: 6000000})

                $(m.el).find(".confirm.yes").click(function() {
                    m.dismiss();

                    data.switches.resetdungeon = 2;

                    M.toast({html: "Reset dungeon"});
                })
                $(m.el).find(".confirm.no").click(function() {
                    m.dismiss();

                    data.switches.resetdungeon = 1;

                    M.toast({html: "Reset dungeon"});
                })
            })



            

            // Remove the loading circle so the user now knows he can use all the features.
            $(".loadingmask").fadeOut(500);

        }


        // Handle the different save types
        async function startSaving(type) {

            // Check if the user filled all fields and isn't currently editing an item name
            let t = canContinue();
            if (t.length == 0) {
                // Update the data from the form which wasn't updated yet
                collectData();
                let hashdata = window.location.hash.split("#")[1].split("|");
                let b;
                // Call the different python save functions with the save hash
                if (type == "slot") {
                    b = await eel.save_slot(data, hashdata[1], hashdata[2])();
                } else if (type == "dat") {
                    b = await eel.save_custom_savefile(data, hashdata[1])();
                } else if (type == "json") {
                    b = await eel.save_json_savefile(data, hashdata[1])();
                }
                
                // On error show error, else show success
                if (b.hasOwnProperty("Error")) {
                    M.toast({
                        html: "The following Error occured: " + b["Error"]
                    });
                } else {
                    M.toast({
                        html: "The operation succeeded"
                    });
                }
            } else {
                for(message in t){
                    // Show message why the user can't continue
                    M.toast({
                        html: t,
                        displayLength: 10000,
                        classes: "red darken-3"
                    });
                }
            }

        }


        // Handle the click on the Add Item Button
        async function addItemButton() {
            let container = $(this).parent().parent().parent().parent();
            let val = container.find("input").val();
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                if (gamedata["items"].indexOf(id) !== -1 || gamedata["items"].indexOf(id.replace(/:\d$/, "")) || settings["expert"]) {
                    let amount = parseInt($(container.find("input")[1]).val());

                    // Check if own inventory or storage inventory
                    if ($(this).parents(".additionalitems").length > 0) {
                        let invindex = parseInt($(this).parents(".inventorycon").find(".invtinfo").attr("id").split(
                            "inv")[1])
                        // Check if the items don't exceed the inventory size
                        if (data["additionalstorage"][invindex]["items"].length < parseInt(container.parent().find(
                                ".invsize").val())) {
                            addItem({id, amount, durability: 1}, $("#inv" + invindex).parent().find(".items"));
                        } else {
                            M.toast({
                                html: "This storage unit only has " + container.parent().find(".invsize").val() +
                                    " spaces!"
                            });
                            return
                        }
                        
                        // Add item
                        data["additionalstorage"][invindex]["items"].push({
                            "amount": amount,
                            "id": id,
                            "durability": 1
                        });
                        
                        // Update the item preview
                        createInventoryMiniPreview(invindex);
                    } else {
                        // Check if the items don't exceed the inventory size
                        if (data["inventory"].length < parseInt(container.parent().find(".invsize").val())) {
                            addItem({id, amount, durability: 1}, $("form>.items"));
                        } else {
                            M.toast({
                                html: "Your inventory only has " + container.parent().find(".invsize").val() +
                                    " spaces!"
                            });
                            return
                        }

                        //Add the new item to the inventory variable
                        data["inventory"].push({
                            "amount": amount,
                            "id": id,
                            "durability": 1
                        })
                    }

                    return
                }
            }
            if (!settings["expert"])
                M.toast({
                    html: "The given item does not exist!"
                });
            else 
                M.toast({
                html: "The following syntax is needed '([item id])' instead of only 1 text."
                });
            
        }

        //Handle the click on the Add Perk Button
        function addPerkButton() {
            let val = $(".item.add.perk input").val();
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                if (gamedata["perks"].indexOf(id) !== -1  || settings["expert"]) {
                    // Check if the perk is already added
                    for (let i = 0; i < data["perks"].length; i++) {
                        if (data["perks"][i]["v"] == id && !settings["expert"]) {
                            M.toast({
                                html: "You already have that perk!"
                            });
                            return
                        }
                    }
                    // Add the HTML of the perk
                    addPerk(id);
                    //Add the new perk to the perks variable
                    data["perks"].push({
                        "s": -1,
                        "v": id
                    })
                    return
                }
            }
            if (!settings["expert"])
                M.toast({
                    html: "The given Perk does not exist!"
                });
            else 
                M.toast({
                html: "The following syntax is needed '([perk id])' instead of only 1 text."
                });
        }

        // Function to update the item preview after change
        async function updateAddItemPreview() {
            console.log($(this.el))
            let val = $(this.el).val();
            console.log(val);
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];

                if(["1","2","3"].includes(id.split(":").pop())){
                    $(this.el).parents(".item").attr("class", "item add " + ["copper", "silver", "gold"][parseInt(id.split(":").pop())-1]);
                } else {
                    $(this.el).parents(".item").attr("class", "item add");
                }

                $(this.el).parents(".item").find(".item_icon").attr("class", "item_icon " + sanitzize_item_id(id));;

                if ( !settings["expert"]){
                    if(!gamedata.items.includes(id)){
                        $(this.el).parents(".item").addClass("unknown_item");
                    } else {
                        $(this.el).parents(".item").removeClass("unknown_item");
                    }
                }
            }
        }

        // Function to update the preview of a perk
        async function updateAddPerkPreview() {
            let val = $(".item.add.perk input").val()
            console.log(val)
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                let url = await getItemUrl(id);
                $(".item.add.perk img").attr("src", url)
                if (data["locals"].hasOwnProperty(id + "_d")) $(".item.add.perk .amount").text(data["locals"][id + "_d"])
                else $(".item.add.perk .amount").text("")
            }
        }

        // Update the data in our data object, which wasn't updated when the user was editing the values
        function collectData() {

            // Values which have their own field
            data["r"]["cur"] = parseInt($("#red").val());
            data["g"]["cur"] = parseInt($("#green").val());
            data["b"]["cur"] = parseInt($("#blue").val());
            data["money"] = parseInt($("#gold").val()) * 100 + parseInt($("#silver").val()) + parseInt($("#copper").val()) /
                100;
            data["hp"] = parseInt($("#hp").val());
            data["energy"]["cur"] = parseInt($("#energy").val());
            data["inventory_size"]["cur"] = parseInt($("#invsize").val());

            // Iterate the items of the own inventory
            let items = $("form>.items .item");
            for (let i = 0; i < items.length; i++) {
                data["inventory"][i]["amount"] = parseInt($(items[i]).find("input").val());
                data["inventory"][i]["id"] = $(items[i]).find(".itemid").text().replace(/\(|\)/g, "");
                data["inventory"][i]["position"] = parseInt($(items[i]).attr("data-position"))
            }

            // Iterate the items of the subinventory
            items = $("form>.equipped-items .item");
            for (let i = 0; i < items.length; i++) {
                data["subinventory"][i]["id"] = $(items[i]).find(".itemid").text().replace(/\(|\)/g, "");
                data["subinventory"][i]["position"] = parseInt($(items[i]).attr("data-position"))
            }



            // Iterate all relationships
            let relationships = $(".relationships input")
            for (let i = 0; i < relationships.length; i++) {
                data["relationships"][i]["cur"] = parseInt($(relationships[i]).val());
            }

            // Iterate all additional storages and their items
            for (let i = 0; i < data["additionalstorage"].length; i++) {
                data["additionalstorage"]["size"] = parseInt($("#inv" + i).parent().find(".invsize").val());
                items = $("#inv" + i).parent().find(".items .item");
                for (let i2 = 0; i2 < items.length; i2++) {
                    data["additionalstorage"][i]["items"][i2]["amount"] = parseInt($(items[i2]).find("input").val());
                    data["additionalstorage"][i]["items"][i2]["id"] = $(items[i2]).find(".itemid").text().replace(
                        /\(|\)/g, "");
                    data["additionalstorage"][i]["items"][i2]["position"] = parseInt($(items[i2]).attr("data-position"))
                }
            }
        }

        // Check if a item didn't autocomplete, so that the user doesn't save old ID's
        function canContinue() {
            let errors = []
            if ($(".currentlyediting").length > 0) errors.push("Please auto complete all Items before saving");
            if ($(".unknown_item").length > 0) errors.push("You currently have non existant items added (they have a red outline when expanded). Please change them. If you actually want to add an item the editor does not support, please enable expert mode in settings. (and reload this page)");

            return errors;
        }

        // Load the settings file
        async function getSettings() {
            settings = await eel.get_settings()();
            if (settings["expert"] === undefined) {
                settings["expert"] = false;
            }
        }

        // Get the information of the save hash, save file type and possibly slot
        $(document).ready(function () {
            let info = window.location.hash.split("#")[1].split("|")
            getSaveFile(info);
            getSettings();
        });
    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>

</html>